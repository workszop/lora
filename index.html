<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRA: Parameter-Efficient Fine-Tuning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-subtle: #eef2ff;
            --purple: #8b5cf6;
            --purple-light: #a78bfa;
            --purple-subtle: #f5f3ff;
            --green: #10b981;
            --green-subtle: #ecfdf5;
            --amber: #f59e0b;
            --amber-subtle: #fffbeb;
            --red: #ef4444;
            --frozen: #94a3b8;
            --frozen-light: #cbd5e1;
            --text: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --bg: #f8fafc;
            --surface: #ffffff;
            --radius: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
        }

        /* ── Header ─────────────────────────────────────────────────── */
        .header {
            padding: 2.5rem 0 1.5rem;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* ── Tabs ───────────────────────────────────────────────────── */
        .tabs {
            display: inline-flex;
            gap: 0.25rem;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 0.25rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .tab:hover { color: var(--text); background: var(--bg); }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        /* ── Main grid ──────────────────────────────────────────────── */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.5rem;
            align-items: start;
        }

        /* ── Card base ──────────────────────────────────────────────── */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        /* ── Visualization card ─────────────────────────────────────── */
        .viz-card {
            padding: 1.5rem;
        }

        .viz-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .viz-top h2 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.4375rem 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface);
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn:hover { border-color: var(--text-tertiary); color: var(--text); }

        .btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn.primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }

        /* ── Network SVG ────────────────────────────────────────────── */
        .network-label {
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .network-label h3 {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text);
        }

        .network-label p {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.125rem;
        }

        .network-svg {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            width: 100%;
            display: block;
        }

        .connection { stroke: #d1d5db; stroke-width: 1.5; opacity: 0.5; }
        .connection.frozen { stroke: var(--frozen-light); stroke-width: 1; opacity: 0.25; }
        .connection.highlight { stroke: url(#connectionGradient); stroke-width: 2.5; filter: url(#glow); opacity: 1; animation: pulse 1.5s ease-in-out infinite; }
        .connection.adapter { stroke: var(--purple-light); stroke-width: 1.5; opacity: 0.4; }
        .connection.adapter.highlight { stroke: url(#adapterGradient); stroke-width: 2.5; filter: url(#adapterGlow); opacity: 1; animation: pulse 1.5s ease-in-out infinite; }

        .neuron { fill: var(--surface); stroke: #d1d5db; stroke-width: 1.5; }
        .neuron.io-neuron { fill: var(--accent); stroke: var(--accent-hover); stroke-width: 2; }
        .neuron.frozen { fill: var(--bg); stroke: var(--frozen-light); opacity: 0.6; }
        .neuron.adapter-neuron { fill: var(--purple-subtle); stroke: var(--purple); stroke-width: 2; }
        .neuron.adapter-neuron.highlight { fill: rgba(139, 92, 246, 0.3); filter: url(#adapterGlow); animation: pulse 1.5s ease-in-out infinite; }

        .layer-label { fill: var(--text-tertiary); font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; text-anchor: middle; }
        .layer-label.adapter-label-text { fill: var(--purple); }
        .frozen-label { fill: var(--frozen); font-family: 'Inter', sans-serif; font-size: 8px; font-weight: 600; text-anchor: middle; letter-spacing: 0.04em; }
        .dim-label { fill: var(--text-tertiary); font-family: 'Inter', sans-serif; font-size: 8px; font-weight: 600; text-anchor: middle; }
        .dim-label.adapter-dim { fill: var(--purple-light); }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ── Legend ──────────────────────────────────────────────────── */
        .legend {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.6875rem;
            color: var(--text-tertiary);
        }

        .legend-swatch { width: 16px; height: 3px; border-radius: 2px; }
        .legend-swatch.active { background: var(--accent); }
        .legend-swatch.frozen { background: var(--frozen-light); }
        .legend-swatch.adapter { background: var(--purple); }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.adapter { background: var(--purple-subtle); border: 1.5px solid var(--purple); }

        /* ── Info badge ─────────────────────────────────────────────── */
        .info-badge {
            display: flex;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            line-height: 1.5;
            margin-top: 1rem;
        }

        .info-badge.warning { background: var(--amber-subtle); color: #92400e; border: 1px solid #fde68a; }
        .info-badge.success { background: var(--green-subtle); color: #065f46; border: 1px solid #a7f3d0; }
        .info-badge strong { font-weight: 600; }
        .info-badge-icon { flex-shrink: 0; font-size: 1rem; }

        /* ── Progress bar ───────────────────────────────────────────── */
        .progress-bar {
            position: relative;
            height: 36px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.2s ease;
            width: 0%;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            letter-spacing: 0.02em;
        }

        /* ── Stats panel ────────────────────────────────────────────── */
        .stats-panel h3 {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 1rem;
        }

        .stat-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child { border-bottom: none; }

        .stat-name {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .stat-values-row {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .stat-val {
            font-size: 0.9375rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .stat-val.full { color: var(--red); }
        .stat-val.lora { color: var(--green); }
        .stat-arrow { color: var(--text-tertiary); font-size: 0.75rem; }

        .stat-tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background: var(--green-subtle);
            border-radius: 4px;
            color: var(--green);
            font-size: 0.625rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            margin-left: 0.5rem;
        }

        .stat-footnote {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            padding-top: 0.25rem;
        }

        /* ── Full-width bottom sections ─────────────────────────────── */
        .bottom-sections {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .bottom-section h3 {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 1rem;
        }

        /* ── Info list ──────────────────────────────────────────────── */
        .info-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .info-list li {
            font-size: 0.8125rem;
            line-height: 1.6;
            color: var(--text-secondary);
            padding-left: 1rem;
            position: relative;
        }

        .info-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.55em;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent);
        }

        .info-list strong { color: var(--text); font-weight: 600; }

        .info-list code {
            background: var(--bg);
            padding: 0.0625rem 0.3125rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--accent);
        }

        /* ── Tip box ────────────────────────────────────────────────── */
        .tip-box {
            background: var(--purple-subtle);
            border: 1px solid #e9e5ff;
            border-radius: var(--radius-sm);
            padding: 1rem 1.25rem;
            font-size: 0.8125rem;
            line-height: 1.6;
            color: #5b21b6;
        }

        .tip-box strong { font-weight: 600; color: #4c1d95; }

        .hidden { display: none; }

        /* ── Responsive ─────────────────────────────────────────────── */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .bottom-sections { grid-template-columns: 1fr; }
        }

        @media (max-width: 640px) {
            .container { padding: 1rem 1rem 3rem; }
            .header h1 { font-size: 1.375rem; }
            .tabs { width: 100%; }
            .tab { flex: 1; text-align: center; font-size: 0.75rem; padding: 0.5rem; }
            .viz-top { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .controls { width: 100%; }
            .btn { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">

        <header class="header">
            <h1>LoRA: Parameter-Efficient Fine-Tuning</h1>
            <p>Jak efektywnie dostrajać duże modele językowe bez potrzeby trenowania wszystkich wag</p>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="full">Full Fine-tuning</button>
            <button class="tab" data-tab="lora">LoRA Fine-tuning</button>
        </div>

        <!-- ── Top grid: visualization + stats ────────────────────── -->
        <div class="main-grid">

            <div class="card viz-card">
                <div class="viz-top">
                    <h2 id="viz-title">Trenowanie wszystkich parametrów</h2>
                    <div class="controls">
                        <button class="btn primary" id="playBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Start
                        </button>
                        <button class="btn" id="resetBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                            Reset
                        </button>
                    </div>
                </div>

                <div id="full-view">
                    <div class="network-label">
                        <h3>LLaMA-7B</h3>
                        <p>7 miliardów wag &mdash; każda aktualizowana w każdym kroku</p>
                    </div>
                    <svg viewBox="0 0 640 380" preserveAspectRatio="xMidYMid meet" class="network-svg" id="fullSvg"></svg>
                    <div class="legend">
                        <div class="legend-item"><span class="legend-swatch active"></span> Trenowane wagi</div>
                    </div>
                    <div class="info-badge warning">
                        <span class="info-badge-icon">&#9888;&#65039;</span>
                        <div><strong>Problem:</strong> Aktualizujemy wszystkie 7B wag. Wymaga wielu kart A100/H100, &gt;120 GB VRAM i bardzo dużo czasu.</div>
                    </div>
                </div>

                <div id="lora-view" class="hidden">
                    <div class="network-label">
                        <h3>LLaMA-7B + LoRA (r=2)</h3>
                        <p>Zamrożona sieć bazowa (szara) + trenowana warstwa adaptera (fioletowa)</p>
                    </div>
                    <svg viewBox="0 0 640 380" preserveAspectRatio="xMidYMid meet" class="network-svg" id="loraSvg"></svg>
                    <div class="legend">
                        <div class="legend-item"><span class="legend-swatch frozen"></span> Zamrożone</div>
                        <div class="legend-item"><span class="legend-dot adapter"></span> LoRA bottleneck</div>
                        <div class="legend-item"><span class="legend-swatch adapter"></span> Trenowane</div>
                    </div>
                    <div class="info-badge success">
                        <span class="info-badge-icon">&#10024;</span>
                        <div><strong>LoRA:</strong> Niskorangowy bottleneck (A&middot;B) &mdash; jedyna trenowana warstwa. 99.94% mniej parametrów!</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <span class="progress-text" id="progressText">Trening: 0%</span>
                </div>
            </div>

            <div class="card stats-panel">
                <h3>Porównanie</h3>

                <div class="stat-row">
                    <span class="stat-name">Parametry</span>
                    <div class="stat-values-row">
                        <span class="stat-val full">7B</span>
                        <span class="stat-arrow">&rarr;</span>
                        <span class="stat-val lora">4.2M</span>
                        <span class="stat-tag">-99.9%</span>
                    </div>
                </div>

                <div class="stat-row">
                    <span class="stat-name">VRAM</span>
                    <div class="stat-values-row">
                        <span class="stat-val full">&gt;120 GB</span>
                        <span class="stat-arrow">&rarr;</span>
                        <span class="stat-val lora">~18 GB</span>
                        <span class="stat-tag">-85%</span>
                    </div>
                </div>
                <div class="stat-footnote">FP32 + optimizer vs FP16 base + adapter</div>

                <div class="stat-row">
                    <span class="stat-name">Czas</span>
                    <div class="stat-values-row">
                        <span class="stat-val full">~48h</span>
                        <span class="stat-arrow">&rarr;</span>
                        <span class="stat-val lora">~4h</span>
                        <span class="stat-tag">12x</span>
                    </div>
                </div>
                <div class="stat-footnote">Orientacyjnie &mdash; zależy od sprzętu i datasetu</div>

                <div class="stat-row">
                    <span class="stat-name">Koszt</span>
                    <div class="stat-values-row">
                        <span class="stat-val full">$$$$</span>
                        <span class="stat-arrow">&rarr;</span>
                        <span class="stat-val lora">$</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── Full-width bottom: how it works + tip ──────────────── -->
        <div class="bottom-sections">
            <div class="card bottom-section">
                <h3>Jak to działa?</h3>
                <ul class="info-list">
                    <li><strong>Zamrożony model bazowy</strong> &mdash; 7B wag nietknięte, gradienty nie liczone</li>
                    <li><strong>Adaptery niskorangowe</strong> &mdash; pary macierzy A&nbsp;(d&times;r) i B&nbsp;(r&times;d) przy projekcjach <code>Wq</code>, <code>Wk</code>, <code>Wv</code></li>
                    <li><strong>Rank (ranga)</strong> &mdash; hiperparametr r kontroluje pojemność adaptera. Typowe: r = 8, 16, 32, 64</li>
                    <li><strong>Matematyka</strong> &mdash; <code>W' = W + (&alpha;/r) &middot; B &middot; A</code>, gdzie B&middot;A to niskorangowa korekta</li>
                    <li><strong>Wymiana adapterów</strong> &mdash; jeden model bazowy + wiele adapterów (~17 MB) dla różnych zadań</li>
                    <li><strong>QLoRA</strong> &mdash; LoRA + 4-bit kwantyzacja = fine-tuning 7B na 6-10 GB VRAM</li>
                </ul>
            </div>

            <div class="card bottom-section">
                <h3>W praktyce</h3>
                <div class="tip-box">
                    <strong>Full fine-tuning LLaMA-7B</strong> wymaga wielu kart A100 (80 GB)
                    ze względu na stany optymalizatora.
                    <br><br>
                    <strong>Z LoRA (FP16)</strong> &mdash; jedna karta A100 (40 GB).
                    <br>
                    <strong>Z QLoRA (4-bit)</strong> &mdash; RTX 3090/4090 (24 GB).
                    <br><br>
                    Adapter zajmuje ~17 MB na dysku &mdash; możesz mieć dziesiątki adapterów do różnych zadań bez powielania modelu.
                </div>
            </div>
        </div>

    </div>

    <script>
        // ── State ──────────────────────────────────────────────────────
        let activeTab = 'full';
        let isAnimating = false;
        let progress = 0;
        let highlightedCells = new Set();
        let animationInterval = null;

        // ── DOM ────────────────────────────────────────────────────────
        const tabs = document.querySelectorAll('.tab');
        const playBtn = document.getElementById('playBtn');
        const resetBtn = document.getElementById('resetBtn');
        const fullView = document.getElementById('full-view');
        const loraView = document.getElementById('lora-view');
        const vizTitle = document.getElementById('viz-title');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const fullSvg = document.getElementById('fullSvg');
        const loraSvg = document.getElementById('loraSvg');

        // ── Network configs ────────────────────────────────────────────
        const fullLayers = [5, 4, 4, 5];
        const fullLabels = ['Embedding', 'Attention', 'FFN', 'Output'];

        const loraLayers = [5, 4, 2, 4, 5];
        const loraLabels = ['Embedding', 'Attention', 'LoRA (r=2)', 'FFN', 'Output'];
        const loraConnTypes = ['frozen', 'adapter', 'adapter', 'frozen'];

        // ── Positioning ────────────────────────────────────────────────
        function pos(layerIdx, nodeIdx, totalNodes, numLayers) {
            const x = layerIdx * (520 / (numLayers - 1)) + 60;
            const y = 190 - ((totalNodes - 1) * 56) / 2 + nodeIdx * 56;
            return { x, y };
        }

        function el(tag, attrs) {
            const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (const k in attrs) e.setAttribute(k, attrs[k]);
            return e;
        }

        // ── SVG defs ───────────────────────────────────────────────────
        function defs(svg) {
            const d = el('defs', {});
            const g1 = el('linearGradient', { id: 'connectionGradient', x1: '0%', y1: '0%', x2: '100%', y2: '0%' });
            g1.appendChild(el('stop', { offset: '0%', 'stop-color': '#6366f1' }));
            g1.appendChild(el('stop', { offset: '100%', 'stop-color': '#8b5cf6' }));
            d.appendChild(g1);

            const g2 = el('linearGradient', { id: 'adapterGradient', x1: '0%', y1: '0%', x2: '100%', y2: '0%' });
            g2.appendChild(el('stop', { offset: '0%', 'stop-color': '#8b5cf6' }));
            g2.appendChild(el('stop', { offset: '100%', 'stop-color': '#a78bfa' }));
            d.appendChild(g2);

            [['glow', '2'], ['adapterGlow', '3']].forEach(([id, std]) => {
                const f = el('filter', { id });
                f.appendChild(el('feGaussianBlur', { stdDeviation: std, result: 'b' }));
                const m = el('feMerge', {});
                m.appendChild(el('feMergeNode', { in: 'b' }));
                m.appendChild(el('feMergeNode', { in: 'SourceGraphic' }));
                f.appendChild(m);
                d.appendChild(f);
            });
            svg.appendChild(d);
        }

        // ── Render full FT ─────────────────────────────────────────────
        function renderFull(svg) {
            svg.innerHTML = '';
            defs(svg);
            const L = fullLayers, n = L.length;
            let id = 0;
            for (let l = 0; l < n - 1; l++)
                for (let i = 0; i < L[l]; i++)
                    for (let j = 0; j < L[l + 1]; j++) {
                        const a = pos(l, i, L[l], n), b = pos(l + 1, j, L[l + 1], n);
                        svg.appendChild(el('line', { x1: a.x, y1: a.y, x2: b.x, y2: b.y, class: `connection${highlightedCells.has(id) && isAnimating ? ' highlight' : ''}` }));
                        id++;
                    }
            L.forEach((sz, l) => { for (let i = 0; i < sz; i++) { const p = pos(l, i, sz, n); svg.appendChild(el('circle', { cx: p.x, cy: p.y, r: (l === 0 || l === n - 1) ? 13 : 11, class: `neuron${(l === 0 || l === n - 1) ? ' io-neuron' : ''}` })); } });
            fullLabels.forEach((t, l) => { const x = pos(l, 0, L[l], n).x; const txt = el('text', { x, y: 28, class: 'layer-label' }); txt.textContent = t; svg.appendChild(txt); });
        }

        // ── Render LoRA ────────────────────────────────────────────────
        function renderLora(svg) {
            svg.innerHTML = '';
            defs(svg);
            const L = loraLayers, n = L.length, AL = 2;
            let id = 0;
            for (let l = 0; l < n - 1; l++) {
                const tp = loraConnTypes[l];
                for (let i = 0; i < L[l]; i++)
                    for (let j = 0; j < L[l + 1]; j++) {
                        const a = pos(l, i, L[l], n), b = pos(l + 1, j, L[l + 1], n);
                        const hit = highlightedCells.has(id); id++;
                        if (tp === 'frozen') svg.appendChild(el('line', { x1: a.x, y1: a.y, x2: b.x, y2: b.y, class: 'connection frozen' }));
                        else svg.appendChild(el('line', { x1: a.x, y1: a.y, x2: b.x, y2: b.y, class: `connection adapter${hit && isAnimating ? ' highlight' : ''}` }));
                    }
            }
            L.forEach((sz, l) => {
                for (let i = 0; i < sz; i++) {
                    const p = pos(l, i, sz, n), io = l === 0 || l === n - 1, ad = l === AL;
                    let c = 'neuron';
                    if (io) c += ' io-neuron';
                    else if (ad) c += ' adapter-neuron' + (isAnimating ? ' highlight' : '');
                    else c += ' frozen';
                    svg.appendChild(el('circle', { cx: p.x, cy: p.y, r: ad ? 15 : (io ? 13 : 11), class: c }));
                }
            });
            loraLabels.forEach((t, l) => { const x = pos(l, 0, L[l], n).x; const txt = el('text', { x, y: 28, class: 'layer-label' + (l === AL ? ' adapter-label-text' : '') }); txt.textContent = t; svg.appendChild(txt); });
            // Dimension labels
            [[1, 2, 'A (d\u2192r)'], [2, 3, 'B (r\u2192d)']].forEach(([f, t, label]) => {
                const mx = (pos(f, 0, L[f], n).x + pos(t, 0, L[t], n).x) / 2;
                const txt = el('text', { x: mx, y: 355, class: 'dim-label adapter-dim' }); txt.textContent = label; svg.appendChild(txt);
            });
            [1, 3].forEach(l => { const x = pos(l, 0, L[l], n).x, ly = pos(l, L[l] - 1, L[l], n).y; const t = el('text', { x, y: ly + 28, class: 'frozen-label' }); t.textContent = 'FROZEN'; svg.appendChild(t); });
        }

        // ── Precompute adapter connection IDs ──────────────────────────
        function countConns(layers) { let t = 0; for (let l = 0; l < layers.length - 1; l++) t += layers[l] * layers[l + 1]; return t; }
        const fullTotal = countConns(fullLayers);
        const adapterIds = [];
        { let id = 0; for (let l = 0; l < loraLayers.length - 1; l++) { const c = loraLayers[l] * loraLayers[l + 1]; if (loraConnTypes[l] === 'adapter') for (let i = id; i < id + c; i++) adapterIds.push(i); id += c; } }

        // ── Update ─────────────────────────────────────────────────────
        function update() {
            if (activeTab === 'full') {
                fullView.classList.remove('hidden'); loraView.classList.add('hidden');
                vizTitle.textContent = 'Trenowanie wszystkich parametrów';
                renderFull(fullSvg);
            } else {
                fullView.classList.add('hidden'); loraView.classList.remove('hidden');
                vizTitle.textContent = 'Trenowanie tylko adaptera LoRA';
                renderLora(loraSvg);
            }
        }

        // ── Animation ──────────────────────────────────────────────────
        function start() {
            isAnimating = true;
            playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Pauza';
            animationInterval = setInterval(() => {
                const step = activeTab === 'lora' ? 4 : 2;
                progress += step;
                if (progress >= 100) { progress = 100; stop(); }
                progressFill.style.width = progress + '%';
                progressText.textContent = progress === 100 ? 'Trening zakończony!' : `Trening: ${progress}%`;
                highlightedCells = new Set();
                if (activeTab === 'full') { for (let i = 0; i < 25; i++) highlightedCells.add(Math.floor(Math.random() * fullTotal)); }
                else { for (let i = 0; i < 8; i++) highlightedCells.add(adapterIds[Math.floor(Math.random() * adapterIds.length)]); }
                update();
            }, 100);
        }

        function stop() {
            isAnimating = false;
            if (animationInterval) { clearInterval(animationInterval); animationInterval = null; }
            playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start';
        }

        function reset() {
            stop(); progress = 0; highlightedCells = new Set();
            progressFill.style.width = '0%';
            progressText.textContent = 'Trening: 0%';
            update();
        }

        // ── Events ─────────────────────────────────────────────────────
        tabs.forEach(tab => tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeTab = tab.dataset.tab;
            reset();
        }));
        playBtn.addEventListener('click', () => isAnimating ? stop() : start());
        resetBtn.addEventListener('click', reset);
        update();
    </script>
</body>
</html>
